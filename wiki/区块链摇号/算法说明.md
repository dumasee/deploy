 XWiki - 设计文档.区块链摇号 - 算法说明               
* * *

***基本构思：***  
基于区块链的分布式去中心化网络，使用智能合约编码实现摇号逻辑，并将摇号数据公开录入到区块链账本，可以在区块链上进行公开的浏览查验，以保证摇号输入的可信度，同时提供智能合约脚本源码和编译后的智能合约字节码，在区块链上可以公开浏览查验，以确保随机算法的公正可信，摇号结果直接输出到区块链公共账本，在区块链上可以公开浏览查验，以确保摇号结果的公正可信。

***具体实施例**：*

a) 提供基于可信公链的区块链智能合约A用于存储摇号过程的输入参数、中间数据和摇号结果  
b) 提供基于可信公链的智能合约B执行摇号过程  
c) 智能合约B的摇号过程如下：  
d) 摇号主体根据摇号业务需要输入可选集合（可选集合总数x）和摇号结果数量（y）要求，系统根据输入内容创建智能合约B的新实例，智能合约B初始化时调用智能合约A将输入集合和结果要求存储到执行的公链上  
e) 执行摇号时，摇号主体在系统中触发摇号动作，系统调用智能合约B在步骤d中创建的新实例，开始摇号执行，执行的算法如下：  
f) 根据输入要求，判断摇号结果的数量y，在智能合约B中创建数量y的私钥，每个私钥是一个256bit的随机值  
g) 将每个256bit的私钥数据转换成16进制的字符串，对转换后的字符串计算字符串指纹整数（hashcode），获取到一个字符串指纹的整数值  
h) 使用该字符串指纹整数值对输入选取集合的总数x取模，取模的结果大于等于0，小于x  
i) 如果有后续的hashcode整数值取模后和前面已经生成的取模结果重复，则重新计算获取新的私钥并计算hashcode进行补充，直到获取到y个取模结果  
j) 对输入的可选集合里的每个元素的数据内容进行私钥填充后再次对填充后的内容进行字符串指纹hashcode运算，然后根据字符串指纹hashcode运算的结果对可选集合的内容进行重新排序。填充的私钥由智能合约直接创建。  
k) 通过前面获取到的y个取模结果，对新排序的可选集合中的元素进行索引运算获取对应元素，对应获取到的元素即为摇号结果  
l) 对摇号结果和所有参与运算的索引计算私钥、可选集合私钥填充值的内容进行整理后调用智能合约A进行上链处理，上链数据均为明文，不做加密  
m) 智能合约A和智能合约B均提供查询接口，随时可查询智能合约的执行结果和过程数据

